import os
import rasterio
import numpy as np
import matplotlib.pyplot as plt
import fiona
import rasterio.mask


with fiona.open("full_cloud_400m_clipped_32635.shp", "r") as shapefile:
    shapes = [feature["geometry"] for feature in shapefile]



with open('finalkeepers_hyytiala_20_21_35VLJ_all.txt') as f:
    alist = f.readlines()


dates = []
iddates = {}
for afile in alist:
    filename = os.path.split(afile)[-1]
    id = filename.split('_')[-1].split('.')[0]
    date = filename.split('_')[1]
    thetype = filename.split('_')[0]
    # space in the end needs to be stripped
    with rasterio.open(afile.strip()) as af:
        ar = af.read(1)
        if np.count_nonzero(ar[ar==99999]) == 0:

            out_image, out_transform = rasterio.mask.mask(af, shapes, crop=True)
            out_meta = af.meta
            out_meta.update({"driver": "GTiff",
                    "height": out_image.shape[1],
                    "width": out_image.shape[2],
                    "transform": out_transform})

            with rasterio.open(filename.split('.')[0]+'_400mcloud.tif', "w", **out_meta) as dest:
                dest.write(out_image)



            ar[(ar < -1) | (ar > 1)] = np.nan
            print(np.nanmin(ar))
            print(np.nanmax(ar))
            plt.imshow(ar)
            plt.colorbar()
            plt.savefig(thetype + '_' + date + '.png')
            plt.clf()

            #keep the date otherwise not
            if not id in iddates.keys():
                iddates[id] =[date]
            if not date in iddates[id]:
                iddates[id].append(date)

print(iddates)
for key in iddates.keys():
    iddates[key].sort(key=int)

print(iddates)


"""
def check_monthly(id, date1, date2):
    monthlydict = {}
    for date in iddates['130']:
        if int(date) > 20210601 and int(date) < 20210801:
            if not '130'
            monthlydict['130'].append(date)
"""

#1:
#dates= ['20200405', '20200407', '20200410', '20200422', '20200430', '20200502', '20200505', '20200507', '20200512', '20200517', '20200522', '20200525', '20200530', '20200601', '20200604', '20200609', '20200611', '20200614', '20200616', '20200619', '20200621', '20200624', '20200626', '20200706', '20200709', '20200714', '20200716', '20200726', '20200731', '20200805', '20200808', '20200810', '20200813', '20200818', '20200820', '20200823', '20200825', '20200828', '20200902', '20200907', '20200914', '20200919', '20200927', '20201002', '20201118', '20210420', '20210512', '20210601', '20210606', '20210619', '20210704', '20210709', '20210726', '20210731', '20210810', '20210825', '20210828', '20210904', '20210909', '20210919', '20210927']

"""
#Noora
iddates = {
    '214': ['20210512', '20210515', '20210525', '20210530', '20210601', '20210604', '20210606', '20210609', '20210611', '20210619', '20210626', '20210629', '20210704', '20210714', '20210716', '20210726', '20210810', '20210813', '20210815', '20210820', '20210828', '20210927', '20211002', '20211012', '20211019', '20211029'], 
    '269': ['20210115', '20210204', '20210206', '20210209', '20210211', '20210214', '20210308', '20210318', '20210326', '20210331', '20210412', '20210415', '20210417', '20210420', '20210430', '20210512', '20210520', '20210522', '20210527', '20210530', '20210604', '20210606', '20210611', '20210619', '20210621', '20210626', '20210629', '20210701', '20210704', '20210711', '20210714', '20210716', '20210719', '20210724', '20210726', '20210729', '20210731', '20210805', '20210808', '20210810', '20210813', '20210818', '20210825', '20210902', '20210904', '20210917', '20210919', '20210927', '20211012', '20211014', '20211017', '20211019', '20211029'], 
    '190': ['20210512', '20210517', '20210519', '20210527', '20210529', '20210601', '20210603', '20210606', '20210608', '20210611', '20210613', '20210623', '20210626', '20210628', '20210703', '20210706', '20210711', '20210713', '20210716', '20210718', '20210726', '20210731', '20210802', '20210805', '20210807', '20210810', '20210815', '20210901', '20210906', '20211004', '20211011', '20211014', '20211019', '20211024', '20211029'], 
    '2753': ['20210512', '20210522', '20210524', '20210529', '20210530', '20210604', '20210608', '20210611', '20210616', '20210618', '20210619', '20210621', '20210701', '20210703', '20210704', '20210711', '20210714', '20210716', '20210718', '20210721', '20210723', '20210726', '20210728', '20210729', '20210731', '20210805', '20210808', '20210810', '20210813', '20210815', '20210901', '20210902', '20210904', '20210916', '20210921', '20210922', '20210926', '20210927', '20211002', '20211006', '20211007', '20211012', '20211014', '20211017', '20211019', '20211024', '20211029'], 
    '130': ['20210512', '20210513', '20210515', '20210518', '20210520', '20210523', '20210527', '20210528', '20210530', '20210601', '20210602', '20210604', '20210606', '20210607', '20210609', '20210611', '20210617', '20210621', '20210627', '20210629', '20210701', '20210702', '20210704', '20210707', '20210712', '20210714', '20210716', '20210717', '20210719', '20210721', '20210722', '20210724', '20210726', '20210727', '20210731', '20210801', '20210806', '20210810', '20210811', '20210813', '20210816', '20210818', '20210820', '20210821', '20210828', '20210831', '20210902', '20210904', '20210909', '20210910', '20210919', '20210927', '20211014', '20211017', '20211019', '20211029'], 
    '2854': ['20210512', '20210522', '20210524', '20210529', '20210530', '20210604', '20210608', '20210611', '20210616', '20210618', '20210619', '20210621', '20210701', '20210703', '20210704', '20210711', '20210714', '20210716', '20210718', '20210721', '20210723', '20210726', '20210728', '20210729', '20210731', '20210802', '20210808', '20210810', '20210813', '20210815', '20210901', '20210902', '20210904', '20210916', '20210922', '20210926', '20210927', '20211006', '20211012', '20211017', '20211019', '20211024'], 
    '213': ['20210512', '20210515', '20210525', '20210530', '20210601', '20210604', '20210606', '20210609', '20210611', '20210619', '20210626', '20210629', '20210704', '20210714', '20210716', '20210721', '20210726', '20210810', '20210813', '20210815', '20210820', '20210828', '20210917', '20210927', '20211002', '20211012', '20211017', '20211019', '20211029']}
"""